'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  ChevronDown,
  MapPin,
  Lightbulb,
  Code,
  ExternalLink,
  Copy,
  Check,
} from 'lucide-react';
import type { Vulnerability, Severity } from '@/types';

interface VulnerabilityCardProps {
  vulnerability: Vulnerability;
  index: number;
  isPaid: boolean;
}

const severityConfig: Record<
  Severity,
  { label: string; color: string; bgColor: string; borderColor: string; emoji: string }
> = {
  critical: {
    label: 'Cr√≠tico',
    color: '#ef4444',
    bgColor: 'rgba(239, 68, 68, 0.1)',
    borderColor: 'rgba(239, 68, 68, 0.3)',
    emoji: 'üî¥',
  },
  high: {
    label: 'Alto',
    color: '#f97316',
    bgColor: 'rgba(249, 115, 22, 0.1)',
    borderColor: 'rgba(249, 115, 22, 0.3)',
    emoji: 'üü†',
  },
  medium: {
    label: 'Medio',
    color: '#eab308',
    bgColor: 'rgba(234, 179, 8, 0.1)',
    borderColor: 'rgba(234, 179, 8, 0.3)',
    emoji: 'üü°',
  },
  low: {
    label: 'Bajo',
    color: '#3b82f6',
    bgColor: 'rgba(59, 130, 246, 0.1)',
    borderColor: 'rgba(59, 130, 246, 0.3)',
    emoji: 'üîµ',
  },
};

export function VulnerabilityCard({
  vulnerability,
  index,
  isPaid,
}: VulnerabilityCardProps) {
  const [isExpanded, setIsExpanded] = useState(index === 0);
  const [copiedCode, setCopiedCode] = useState<'bad' | 'good' | null>(null);

  const config = severityConfig[vulnerability.severity];

  const copyToClipboard = async (code: string, type: 'bad' | 'good') => {
    await navigator.clipboard.writeText(code);
    setCopiedCode(type);
    setTimeout(() => setCopiedCode(null), 2000);
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay: index * 0.1 }}
      className="rounded-xl overflow-hidden"
      style={{
        background: config.bgColor,
        border: `1px solid ${config.borderColor}`,
      }}
    >
      {/* Header - always visible */}
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full p-5 flex items-start gap-4 text-left hover:bg-white/5 transition-colors"
      >
        {/* Severity indicator */}
        <div
          className="flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center text-lg"
          style={{ background: `${config.color}20` }}
        >
          {config.emoji}
        </div>

        {/* Title and info */}
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 mb-1">
            <span
              className="text-xs font-semibold px-2 py-0.5 rounded-full"
              style={{
                background: config.bgColor,
                color: config.color,
                border: `1px solid ${config.borderColor}`,
              }}
            >
              {config.label}
            </span>
          </div>
          <h4 className="font-semibold text-white text-lg">{vulnerability.title}</h4>
          <p className="text-gray-400 text-sm mt-1 line-clamp-2">
            {vulnerability.description}
          </p>
        </div>

        {/* Expand icon */}
        <ChevronDown
          className={`w-5 h-5 text-gray-400 transition-transform ${
            isExpanded ? 'rotate-180' : ''
          }`}
        />
      </button>

      {/* Expandable content */}
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="overflow-hidden"
          >
            <div className="px-5 pb-5 space-y-4">
              {/* Divider */}
              <div className="h-px bg-white/10" />

              {/* Location (if available and paid) */}
              {isPaid && vulnerability.location && (
                <div className="flex items-start gap-3 p-3 bg-black/20 rounded-lg">
                  <MapPin className="w-5 h-5 text-cyan-400 flex-shrink-0 mt-0.5" />
                  <div>
                    <p className="text-sm text-gray-400">Ubicaci√≥n</p>
                    <p
                      className="text-white font-mono text-sm break-all"
                      style={{ fontFamily: "'JetBrains Mono', monospace" }}
                    >
                      {vulnerability.location}
                      {vulnerability.lineNumber && ` (l√≠nea ${vulnerability.lineNumber})`}
                    </p>
                  </div>
                </div>
              )}

              {/* Found value (if available and paid) */}
              {isPaid && vulnerability.foundValue && (
                <div className="flex items-start gap-3 p-3 bg-black/20 rounded-lg">
                  <Code className="w-5 h-5 text-orange-400 flex-shrink-0 mt-0.5" />
                  <div>
                    <p className="text-sm text-gray-400">Valor encontrado</p>
                    <code
                      className="text-orange-400 font-mono text-sm"
                      style={{ fontFamily: "'JetBrains Mono', monospace" }}
                    >
                      {vulnerability.foundValue}
                    </code>
                  </div>
                </div>
              )}

              {/* Remediation steps */}
              <div className="space-y-3">
                <div className="flex items-center gap-2 text-cyan-400">
                  <Lightbulb className="w-5 h-5" />
                  <span className="font-semibold">C√≥mo solucionarlo</span>
                </div>

                {isPaid ? (
                  <ol className="space-y-2 pl-6">
                    {vulnerability.remediation.steps.map((step, i) => (
                      <li
                        key={i}
                        className="text-gray-300 text-sm relative before:absolute before:left-[-1.5rem] before:content-[counter(list-item)'.'] before:text-cyan-400 before:font-mono"
                        style={{ counterIncrement: 'list-item' }}
                      >
                        {step}
                      </li>
                    ))}
                  </ol>
                ) : (
                  <div className="text-gray-500 text-sm italic">
                    üîí Desbloquea el reporte completo para ver la soluci√≥n
                  </div>
                )}
              </div>

              {/* Code examples (if available and paid) */}
              {isPaid && vulnerability.remediation.codeExample && (
                <div className="space-y-4">
                  {/* Bad example */}
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm text-red-400 font-medium flex items-center gap-1">
                        ‚ùå Incorrecto
                      </span>
                      <button
                        onClick={() =>
                          copyToClipboard(
                            vulnerability.remediation.codeExample!.bad,
                            'bad'
                          )
                        }
                        className="text-gray-500 hover:text-white transition-colors"
                      >
                        {copiedCode === 'bad' ? (
                          <Check className="w-4 h-4 text-green-400" />
                        ) : (
                          <Copy className="w-4 h-4" />
                        )}
                      </button>
                    </div>
                    <pre className="code-block text-red-300/80 overflow-x-auto">
                      {vulnerability.remediation.codeExample.bad}
                    </pre>
                  </div>

                  {/* Good example */}
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm text-green-400 font-medium flex items-center gap-1">
                        ‚úÖ Correcto
                      </span>
                      <button
                        onClick={() =>
                          copyToClipboard(
                            vulnerability.remediation.codeExample!.good,
                            'good'
                          )
                        }
                        className="text-gray-500 hover:text-white transition-colors"
                      >
                        {copiedCode === 'good' ? (
                          <Check className="w-4 h-4 text-green-400" />
                        ) : (
                          <Copy className="w-4 h-4" />
                        )}
                      </button>
                    </div>
                    <pre className="code-block text-green-300/80 overflow-x-auto">
                      {vulnerability.remediation.codeExample.good}
                    </pre>
                  </div>
                </div>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  );
}
